#!/usr/bin/env sh
set -euo pipefail
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Speckit Constitution Compliance Check..."
echo ""

# Get staged files
STAGED_FILES=$(git diff --cached --name-only)
BACKEND_CHANGES=$(echo "$STAGED_FILES" | grep "^backend/src/" || true)
FRONTEND_CHANGES=$(echo "$STAGED_FILES" | grep "^frontend/src/" || true)

# If NO backend or frontend code changes, skip all checks
if [ -z "$BACKEND_CHANGES" ] && [ -z "$FRONTEND_CHANGES" ]; then
    echo "‚ÑπÔ∏è  No backend/frontend source changes detected."
    echo "‚úÖ Skipping Speckit validation and tests."
    echo ""
    exit 0
fi

echo "üìã Backend/Frontend code changes detected. Validating Speckit compliance..."
echo ""

# Get current branch name
BRANCH_NAME=$(git branch --show-current)

# Extract feature number from branch name (e.g., 001-feature-name -> 001)
FEATURE_NUM=$(echo "$BRANCH_NAME" | grep -oE '^[0-9]{3}' || true)

if [ -n "$FEATURE_NUM" ]; then
    echo "üî¢ Feature branch detected: $BRANCH_NAME (Feature #$FEATURE_NUM)"
    echo ""

    # Find matching spec directory
    MATCHING_SPEC=$(find specs -maxdepth 1 -type d -name "${FEATURE_NUM}-*" 2>/dev/null | head -n 1 || true)

    if [ -z "$MATCHING_SPEC" ]; then
        echo "‚ùå COMMIT BLOCKED: No matching spec directory found for feature $FEATURE_NUM"
        echo ""
        echo "üìÇ Expected something like: specs/${FEATURE_NUM}-feature-name/"
        echo ""
        echo "üîß To fix:"
        echo "   1. Create the spec directory:"
        echo "      mkdir -p specs/${FEATURE_NUM}-feature-name"
        echo ""
        echo "   2. Create required Speckit files:"
        echo "      ./.specify/scripts/bash/generate-spec-docs.sh $FEATURE_NUM"
        echo ""
        echo "   Or use templates:"
        echo "      cp .specify/templates/spec-template.md specs/${FEATURE_NUM}-feature-name/spec.md"
        echo "      cp .specify/templates/plan-template.md specs/${FEATURE_NUM}-feature-name/plan.md"
        echo "      cp .specify/templates/tasks-template.md specs/${FEATURE_NUM}-feature-name/tasks.md"
        echo ""
        echo "üìñ See .specify/AI_AGENT_INSTRUCTIONS.md for details"
        exit 1
    fi

    echo "   ‚úÖ Found spec directory: $MATCHING_SPEC"
    echo ""

    # Check for required files and ensure they are not empty
    MISSING_FILES=""
    EMPTY_FILES=""

    # Check spec.md
    if [ ! -f "$MATCHING_SPEC/spec.md" ]; then
        MISSING_FILES="$MISSING_FILES\n   ‚ùå spec.md (missing)"
    elif [ ! -s "$MATCHING_SPEC/spec.md" ]; then
        EMPTY_FILES="$EMPTY_FILES\n   ‚ö†Ô∏è  spec.md (empty)"
    else
        echo "   ‚úÖ spec.md exists and is not empty"
    fi

    # Check plan.md
    if [ ! -f "$MATCHING_SPEC/plan.md" ]; then
        MISSING_FILES="$MISSING_FILES\n   ‚ùå plan.md (missing)"
    elif [ ! -s "$MATCHING_SPEC/plan.md" ]; then
        EMPTY_FILES="$EMPTY_FILES\n   ‚ö†Ô∏è  plan.md (empty)"
    else
        echo "   ‚úÖ plan.md exists and is not empty"
    fi

    # Check tasks.md
    if [ ! -f "$MATCHING_SPEC/tasks.md" ]; then
        MISSING_FILES="$MISSING_FILES\n   ‚ùå tasks.md (missing)"
    elif [ ! -s "$MATCHING_SPEC/tasks.md" ]; then
        EMPTY_FILES="$EMPTY_FILES\n   ‚ö†Ô∏è  tasks.md (empty)"
    else
        echo "   ‚úÖ tasks.md exists and is not empty"
    fi

    # Block commit if files are missing or empty
    if [ -n "$MISSING_FILES" ] || [ -n "$EMPTY_FILES" ]; then
        echo ""
        echo "‚ùå COMMIT BLOCKED: Required Speckit files are missing or empty:"

        if [ -n "$MISSING_FILES" ]; then
            echo -e "$MISSING_FILES"
        fi

        if [ -n "$EMPTY_FILES" ]; then
            echo -e "$EMPTY_FILES"
        fi

        echo ""
        echo "üìñ According to .specify/memory/constitution.md:"
        echo "   All features MUST have complete spec.md, plan.md, and tasks.md"
        echo ""
        echo "üîß To fix:"
        echo "   1. Use templates in .specify/templates/ to create/populate files"
        echo "   2. Or use: ./.specify/scripts/bash/generate-spec-docs.sh $FEATURE_NUM"
        echo "   3. Fill in all required sections before committing"
        echo ""
        echo "üìö See .specify/AI_AGENT_INSTRUCTIONS.md for details"
        exit 1
    fi

    echo ""
    echo "‚úÖ All Speckit files present and validated"
else
    echo "‚ÑπÔ∏è  Branch '$BRANCH_NAME' does not follow NNN-feature-name pattern"
    echo "   Skipping Speckit validation (but tests will still run)"
fi

echo ""
echo "üß™ Running tests before commit..."
echo ""

# Backend tests
if [ -f "backend/package.json" ]; then
    echo "üîµ Running backend tests..."
    cd backend && npm test -- --passWithNoTests
    BACKEND_EXIT=$?
    cd ..

    if [ $BACKEND_EXIT -ne 0 ]; then
        echo ""
        echo "‚ùå COMMIT BLOCKED: Backend tests failed!"
        echo ""
        echo "üìñ According to .specify/memory/constitution.md:"
        echo "   All commits MUST pass tests with 80%+ coverage"
        echo ""
        echo "üîß To fix:"
        echo "   1. Review test failures above"
        echo "   2. Fix failing tests or add missing tests"
        echo "   3. Ensure coverage thresholds are met (80%+ statements)"
        echo "   4. Re-run: cd backend && npm test"
        echo ""
        echo "üö´ NEVER use 'git commit --no-verify' to bypass this check"
        exit 1
    fi
    echo "   ‚úÖ Backend tests passed"
else
    echo "   ‚ö†Ô∏è  backend/package.json not found, skipping backend tests"
fi

echo ""

# Frontend tests
if [ -f "frontend/package.json" ]; then
    echo "üîµ Running frontend tests..."
    cd frontend && npm run test:run -- --passWithNoTests
    FRONTEND_EXIT=$?
    cd ..

    if [ $FRONTEND_EXIT -ne 0 ]; then
        echo ""
        echo "‚ùå COMMIT BLOCKED: Frontend tests failed!"
        echo ""
        echo "üìñ According to .specify/memory/constitution.md:"
        echo "   All commits MUST pass tests"
        echo ""
        echo "üîß To fix:"
        echo "   1. Review test failures above"
        echo "   2. Fix failing tests or add missing tests"
        echo "   3. Re-run: cd frontend && npm run test:run"
        echo ""
        echo "üö´ NEVER use 'git commit --no-verify' to bypass this check"
        exit 1
    fi
    echo "   ‚úÖ Frontend tests passed"
else
    echo "   ‚ö†Ô∏è  frontend/package.json not found, skipping frontend tests"
fi

echo ""
echo "‚úÖ All Speckit checks and tests passed. Proceeding with commit."
echo ""
